{% extends 'base.html' %}
{% block title %}SafeIMEI - Home{% endblock %}

{% block content %}
{% include 'partials/navbar_public.html' %}
<div class="page pt-16">
    {% if alert_success %}
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
        <div class="p-4 rounded-md bg-green-100 border-l-4 border-green-500 text-green-700">
            <p class="font-bold">Thank You!</p>
            <p>Your anonymous tip has been sent to the authorities. Your help is greatly appreciated.</p>
        </div>
    </div>
{% endif %}
    <header class="bg-white">
        <div class="max-w-7xl mx-auto py-20 px-4 sm:px-6 lg:px-8 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl md:text-6xl">Buy Used Phones with Confidence.</h1>
            <p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500">Instantly check if a phone has been reported stolen with Nigeria's official IMEI database.</p>
            <div class="mt-10 max-w-xl mx-auto">
                <form method="POST" action="{% url 'home' %}" class="sm:flex sm:gap-2 sm:items-start">
                    {% csrf_token %}
                    <div class="w-full">
                        <input name="imei" id="public-imei-input" type="text" maxlength="15" placeholder="Enter 15-digit IMEI number" class="w-full px-5 py-4 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-lg" required />
                        <p id="public-imei-feedback" class="mt-2 text-xs text-left h-4"></p> {# Added h-4 to prevent layout shift #}
                    </div>
                    <button type="submit" id="public-imei-submit" class="mt-3 w-full sm:mt-0 sm:w-auto sm:flex-shrink-0 inline-flex items-center justify-center px-6 py-4 border border-transparent text-lg font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">Check IMEI</button>
                </form>

                {% if imei_result %}
             <div class="mt-6">
                {% if imei_result.status == 'stolen' %}
                <div class="p-4 rounded-md text-left bg-red-100 border-l-4 border-red-500 text-red-700">
                    <p class="font-bold">Warning!</p>
                    <p>{{ imei_result.message }}</p>
                </div>

                <div class="mt-6 p-4 rounded-md text-left bg-blue-50 border border-blue-200">
                    <h3 class="font-bold text-blue-800">You Can Help Recover This Device</h3>
                    <p class="text-sm text-blue-700 mt-2">
                        By clicking the button below, you can anonymously send your approximate location (your city)
                        to the police station that filed this report. This information can help them in their investigation.
                    </p>
                    <p class="text-xs text-blue-600 mt-1">
                        <strong>Note:</strong> We will not share your exact location or any of your personal information.
                    </p>
                    <form method="POST" action="{% url 'anonymous_alert' %}">
                        {% csrf_token %}
                        <input type="hidden" name="imei" value="{{ imei_result.imei }}">
                        <button type="submit" class="mt-4 w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                            Anonymously Alert Police
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="p-4 rounded-md text-left bg-green-100 border-l-4 border-green-500 text-green-700">
                    <p class="font-bold">All Clear!</p>
                    <p>{{ imei_result.message }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
                

            </div>
        </div>
    </header>
    <section class="bg-gray-50 py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h2 class="text-base text-blue-600 font-semibold tracking-wide uppercase">How It Works</h2>
                <p class="mt-2 text-3xl font-extrabold text-gray-900 tracking-tight sm:text-4xl">A Simple Process for Peace of Mind</p>
            </div>
            <div class="mt-12 grid gap-10 md:grid-cols-3">
                <div class="text-center p-6 bg-white rounded-lg shadow-md"><div class="text-4xl mb-4">1.</div><h3 class="text-xl font-bold">Report a Theft</h3><p class="mt-2 text-gray-500">Victims report their stolen device at an authorized police station.</p></div>
                <div class="text-center p-6 bg-white rounded-lg shadow-md"><div class="text-4xl mb-4">2.</div><h3 class="text-xl font-bold">We Verify & Log</h3><p class="mt-2 text-gray-500">Police verify the report and add the IMEI to our secure national database.</p></div>
                <div class="text-center p-6 bg-white rounded-lg shadow-md"><div class="text-4xl mb-4">3.</div><h3 class="text-xl font-bold">You Check Before Buying</h3><p class="mt-2 text-gray-500">Enter the phone's IMEI on our site to see its status instantly.</p></div>
            </div>
        </div>
    </section>
</div>
{% include 'partials/footer_public.html' %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const imeiInput = document.getElementById('public-imei-input');
    const submitButton = document.getElementById('public-imei-submit');
    const feedbackElement = document.getElementById('public-imei-feedback');

    function isValidLuhn(imei) {
        let nCheck = 0, bEven = false;
        imei = imei.replace(/\D/g, "");
        for (let n = imei.length - 1; n >= 0; n--) {
            let cDigit = imei.charAt(n), nDigit = parseInt(cDigit, 10);
            if (bEven && (nDigit *= 2) > 9) nDigit -= 9;
            nCheck += nDigit;
            bEven = !bEven;
        }
        return (nCheck % 10) == 0;
    }

    function validateImei() {
        const imei = imeiInput.value;
        let isValid = false;

        imeiInput.style.borderColor = '#d1d5db';
        feedbackElement.textContent = '';
        feedbackElement.style.color = '';

        if (imei.length === 0) {
            submitButton.disabled = true;
            return;
        }

        if (/[^0-9]/.test(imei)) {
            feedbackElement.textContent = 'IMEI must contain only numbers.';
            feedbackElement.style.color = '#ef4444';
            imeiInput.style.borderColor = '#ef4444';
        } else if (imei.length !== 15) {
            feedbackElement.textContent = `IMEI must be 15 digits long. (${imei.length}/15)`;
            feedbackElement.style.color = '#ef4444';
            imeiInput.style.borderColor = '#ef4444';
        } else {
            if (isValidLuhn(imei)) {
                feedbackElement.textContent = 'Valid IMEI format.';
                feedbackElement.style.color = '#22c55e';
                imeiInput.style.borderColor = '#22c55e';
                isValid = true;
            } else {
                feedbackElement.textContent = 'Invalid IMEI. Please check the number.';
                feedbackElement.style.color = '#ef4444';
                imeiInput.style.borderColor = '#ef4444';
            }
        }

        submitButton.disabled = !isValid;
        submitButton.style.cursor = isValid ? 'pointer' : 'not-allowed';
        submitButton.style.opacity = isValid ? '1' : '0.5';
    }

    validateImei();
    imeiInput.addEventListener('input', validateImei);
});
</script>
{% endblock %}