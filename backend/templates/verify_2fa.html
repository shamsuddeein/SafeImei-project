{% extends 'base.html' %}
{% block title %}Two-Factor Authentication{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
    <div class="sm:mx-auto sm:w-full sm:max-w-md">
        <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">Two-Factor Authentication</h2>
        <p class="mt-2 text-center text-sm text-gray-600">Enter the 6-digit code sent to your registered email.</p>
    </div>
    <div class="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
        <div class="bg-white py-8 px-4 shadow-lg sm:rounded-lg sm:px-10">
            <form method="POST" id="2fa-form">
                {% csrf_token %}
                
                <input name="code" id="id_code" type="hidden" required />

                <div class="flex justify-center gap-2 md:gap-4 mb-6" id="otp-container">
                    {% for i in "123456" %}
                    <input 
                        type="text" 
                        maxlength="1" 
                        class="otp-input w-12 h-14 md:w-14 md:h-16 text-center text-2xl font-semibold border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                        required 
                    />
                    {% endfor %}
                </div>

                {% if error %}
                <div class="text-sm text-red-600 text-center mb-4">{{ error }}</div>
                {% endif %}
                <button type="submit" class="w-full flex justify-center py-2 px-4 border rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Verify</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('2fa-form');
    const otpContainer = document.getElementById('otp-container');
    const inputs = otpContainer.querySelectorAll('.otp-input');
    const hiddenInput = document.getElementById('id_code');

    // 1. Focus first input on load
    if (inputs.length > 0) {
        inputs[0].focus();
    }

    // 2. Handle Paste Event (The "Pro" Feature)
    otpContainer.addEventListener('paste', function(e) {
        e.preventDefault();
        const pasteData = (e.clipboardData || window.clipboardData).getData('text');
        
        // clean data to only keep numbers
        const cleanData = pasteData.replace(/\D/g, '').slice(0, 6); 

        cleanData.split('').forEach((char, index) => {
            if (inputs[index]) {
                inputs[index].value = char;
            }
        });
        
        // Focus the next empty input or the last one
        const nextIndex = cleanData.length;
        if (inputs[nextIndex]) {
            inputs[nextIndex].focus();
        } else {
            inputs[5].focus(); 
        }
    });

    // 3. Handle Typing
    otpContainer.addEventListener('input', function(e) {
        const target = e.target;
        const value = target.value;

        if (isNaN(value)) {
            target.value = '';
            return;
        }

        if (value !== '') {
            const next = target.nextElementSibling;
            if (next && next.tagName === 'INPUT') {
                next.focus();
            }
        }
    });

    // 4. Handle Backspace
    otpContainer.addEventListener('keydown', function(e) {
        const target = e.target;
        if (e.key === 'Backspace' || e.key === 'Delete') {
            if (target.value === '') {
                const prev = target.previousElementSibling;
                if (prev && prev.tagName === 'INPUT') {
                    prev.focus();
                }
            }
        }
    });

    // 5. Combine on Submit
    form.addEventListener('submit', function(e) {
        let otp = '';
        inputs.forEach(input => {
            otp += input.value;
        });
        hiddenInput.value = otp;
    });
});
</script>
{% endblock %}